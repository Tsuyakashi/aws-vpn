name: Deploy Infra

on:
  workflow_dispatch:

jobs:
  infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Ensure RSA keys exist for Terraform
        working-directory: terraform
        run: |
          if [ ! -f "./keys/rsa.key" ]; then
            mkdir -p keys
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > keys/rsa.key
            chmod 600 keys/rsa.key
            ssh-keygen -y -f keys/rsa.key > keys/rsa.key.pub
          fi
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} 
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}  
          
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init / Apply
        working-directory: terraform
        run: |
          terraform init
          terraform apply --auto-approve

      - name: Create S3 bucket for tfstate
        run: |
          aws s3api create-bucket \
            --bucket ${{ vars.BUCKET_NAME }} \
            --region ${{ secrets.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ secrets.AWS_REGION }}
          aws s3api put-bucket-encryption \
            --bucket ${{ vars.BUCKET_NAME }} \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          
      - name: Upload tf state to s3 bucket
        working-directory: terraform
        run: |
          aws s3 cp terraform.tfstate \
            s3://${{ vars.BUCKET_NAME }}/terraform.tfstate

      - name: Generate Ansible Host File
        working-directory: terraform
        run: |
          HOST=$(terraform output -raw instance_hostname)

          echo "[hosts]" > ../ansible/hosts
          echo "$HOST" >> ../ansible/hosts

      - name: Wait for SSH to become available
        working-directory: terraform
        run: |
          HOST=$(terraform output -raw instance_hostname)
          for i in {1..30}; do
            if nc -z "$HOST" 22; then
              echo "SSH is up!"
              exit 0
            fi
            echo "Waiting for SSHâ€¦"
            sleep 5
          done
          echo "SSH did not become available in time."
          exit 1

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: Run Ansible
        working-directory: ansible
        run: |
          ansible-playbook \
            -i hosts \
            -i inventory.ini \
            main.yml

      - name: Upload WireGuard config
        uses: actions/upload-artifact@v4
        with:
          name: wg-config
          path: ansible/wg0-client-user-cfg.conf
